<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs 
	title="__MSG_daysuntil__"
	title_url="http://leancode.com/daysuntil/"
	directory_title="__MSG_daysuntil__ __MSG_countdown__"
	description="__MSG_description__"
	scrolling="false"
	singleton="false"
	author="Bernie T."
	author_email="widgets@leancode.com"
	author_affiliation="Leancode Inc."
	author_location="Bellevue, WA"
	screenshot="http://daysuntil.googlecode.com/svn/trunk/screenshot.png"
	thumbnail="http://daysuntil.googlecode.com/svn/trunk/thumbnail.png"
	author_photo="http://daysuntil.googlecode.com/svn/trunk/author_photo.png"
	author_aboutme="Software developer and entrepreneur. Look me up to talk about your next project."
	author_quote="We can never know about the days to come. But we think about them anyway...Anticipation. - Carly"
	author_link="http://leancode.com/"
>
	<Locale messages="http://daysuntil.googlecode.com/svn/trunk/ALL_ALL.xml"/>
	<Require feature="analytics"/>
	<Require feature="setprefs"/>
	<Require feature="dynamic-height"/>
</ModulePrefs>
<UserPref name="reminders" display_name="__MSG_yourreminders__" datatype="string" default_value="[]"></UserPref>
<UserPref name="version" display_name="__MSG_daysuntil__ __MSG_version__" datatype="string" default_value=" $Rev$ "></UserPref>
<Content type="html">
<![CDATA[

<script language="JavaScript" src="http://daysuntil.googlecode.com/svn/trunk/json.js"></script>

<script>
	
	var reminders__MODULE_ID__; // This is a json object of reminders (array of hashes with 'name' & 'date')
	var prefs__MODULE_ID__;
	var seconds = 1000;
	var minutes = seconds*60;
	var hours = minutes*60;
	var days = hours*24;
	var years = days*365;
	
	_IG_RegisterOnloadHandler(onLoad__MODULE_ID__);
	
	function onLoad__MODULE_ID__() {
		prefs__MODULE_ID__ = new _IG_Prefs(__MODULE_ID__);
		loadReminders__MODULE_ID__();	
	}
		
	function loadReminders__MODULE_ID__() {
		var reminders = prefs__MODULE_ID__.getString("reminders");
		
		reminders__MODULE_ID__ = [];
		
		if (reminders != "") {
			reminders__MODULE_ID__ = reminders.parseJSON(function (key, value) {
			        return key == 'date' ? new Date(parseInt(value)) : value;
			    });
		}
		
		reminders__MODULE_ID__.sort(sortRemindersAscending);
		resetForm__MODULE_ID__();
		createTable__MODULE_ID__();
	}

	function saveReminders__MODULE_ID__(){
		prefs__MODULE_ID__.set("reminders", reminders__MODULE_ID__.toJSONString());
		loadReminders__MODULE_ID__();
	}
	
	// a,b must be reminders (which have hashed 'name' and 'date' keys)
	function sortRemindersAscending(a,b) {
		var x = calendarDaysUntil(a.date);
		var y = calendarDaysUntil(b.date);
		
		return ((x < y) ? -1 : ((x > y) ? 1 : 0));
	}
	
	// returns integer with calendar days until the endDate
	// (from the today's prior midnight, until the prior midnight of endDate)
	// endDate is a Date object
	// moves the year, if necessary, to insure that the date is in the future
	function calendarDaysUntil(endDate) {
		var nowDate = new Date();
		
		// Roll clocks back to midnight
		var endDay = new Date(endDate.getYear(), endDate.getMonth(), endDate.getDate());
		var nowDay = new Date(nowDate.getYear(), nowDate.getMonth(), nowDate.getDate());
		
		if (endDay.getTime() < nowDay.getTime()) {
			// use date functions to avoid extra leap days, etc.
			endDay.setFullYear(nowDay.getFullYear());
			
			// if endDay is in the past year to date, still
			// need to go forward one additional year
			if (endDay.getTime() < nowDay.getTime()) {
				endDay.setFullYear(nowDay.getFullYear()+1);
			}
		}
		
		return Math.ceil((endDay.getTime()-nowDay.getTime())/days);
	}
	
	function resetForm__MODULE_ID__() {
		var now = new Date();
		
		_gel("newYear__MODULE_ID__").value = now.getFullYear();
		_gel("newMonth__MODULE_ID__").value = (now.getMonth()+1);
		_gel("newDay__MODULE_ID__").value = now.getDate();
	}

	function addReminder__MODULE_ID__(description, year, month, day) {
		var description = _trim(description);
		var date = new Date(parseInt(year),parseInt(month)-1,parseInt(day));
		
		_gel("newDescription__MODULE_ID__").value = "";
		if (description == "")
			return;
			
		reminders__MODULE_ID__[reminders__MODULE_ID__.length] =
			{"name": description, "date": date };
			
		saveReminders__MODULE_ID__();
		createTable__MODULE_ID__();
		return false;
	}

	function deleteReminder__MODULE_ID__(number) {
		var beginning = reminders__MODULE_ID__.slice(0, number);
		var end = reminders__MODULE_ID__.slice(number + 1,
		                                      reminders__MODULE_ID__.length);
		
		reminders__MODULE_ID__ = beginning.concat(end);
		saveReminders__MODULE_ID__();
		createTable__MODULE_ID__();
	}
	
	function rowClass__MODULE_ID__(number) {
		if (number % 2 != 0)
			return " class=odd__MODULE_ID__ ";
		else
			return " class=even__MODULE_ID__ ";
	}

	function createTable__MODULE_ID__() {
		var html = "<table cellspacing=2px id=remindersTable__MODULE_ID__>";
		
		for (i = 0; i < reminders__MODULE_ID__.length; i++) {
			if (reminders__MODULE_ID__[i] == null)
				break;
			
			var name = reminders__MODULE_ID__[i].name;
			var date = reminders__MODULE_ID__[i].date;
		
			html = html + createRow__MODULE_ID__(i, name, date);
		}
		
		html = html + "</table>";
		_gel("remindersDiv__MODULE_ID__").innerHTML = html;
		_IG_AdjustIFrameHeight();
	}

	function createRow__MODULE_ID__(number, description, reminder_date) {
		var now = new Date();
		var daysuntil = calendarDaysUntil(reminder_date);
		
		var html =
			"<tr id=\"row" + number + "__MODULE_ID__\"" +
			rowClass__MODULE_ID__(number) + ">" +
			"<td class=description_td__MODULE_ID__><span class=description_ds__MODULE_ID__>" +
			_hesc(description) +
			"</span></td>" +
			"<td class=date_display__MODULE_ID__><div class=date_display__MODULE_ID__>" + 
			daysuntil +
			"</div></td>" +
			"<td>" +
			createDelete__MODULE_ID__(number) +
			"</td>" +
			"</tr>";

		return html;
	}

	function createDelete__MODULE_ID__(number) {
		var img = _IG_GetImageUrl('http://daysuntil.googlecode.com/svn/trunk/x.gif');
		var html =
			"<a href=\"javascript:deleteReminder__MODULE_ID__(" + number + ")\">" +
			"<img class=delete__MODULE_ID__" +
			" src=\"" + img + "\">" +
			"</a>";
		return html;
	}

	function getRow__MODULE_ID__(number) {
		return _gel("row" + number + "__MODULE_ID__");
	}

	function getCol__MODULE_ID__(row, index) {
		return row.childNodes.item(index);
	}

	_IG_Analytics("UA-99119-12", "/daysuntil");
	
</script>

<style type="text/css">

	p { 
		font-family: arial, sans-serif;
		font-size: small;
	}
	
	td.date_display__MODULE_ID__ {
		text-align: right;
		padding 0px 2px 0px 2px;
	}
	
	td.description_td__MODULE_ID__ {
		text-align: center;
		width: 100%
	}
	
	span.description_ds__MODULE_ID__ {

		font-family: arial, sans-serif;
		font-size: small;
		margin: 0 auto;
		padding: 0 5px 0 5px;
	}
	
	div.date_display__MODULE_ID__ {
		border: 2px solid #003300;
		background-color: #33FF66;
		color: #003300;
		font-family: arial, san-serif;
		font-size: normal;
		font-weight: bold;
		padding: 0px 2px 0px 2px;
		margin: 0 2px;
		float: right;
	}
	
	img.delete__MODULE_ID__ {
	    border: 0;
		margin: 0 2px 0 10px;
		padding: 0;
	}
	
	form {
		border: 0;
		margin: 0;
		padding: 0;
	}
	
	div#remindersDiv__MODULE_ID__ {
		border: 0;
		margin: 0;
		padding: 0;
	}
	
</style>

<form name = "newReminderForm__MODULE_ID__"
	onsubmit="return addReminder__MODULE_ID__(
	document.newReminderForm__MODULE_ID__.
	newDescription__MODULE_ID__.value,
	newYear__MODULE_ID__.value,
	document.newReminderForm__MODULE_ID__.
	newMonth__MODULE_ID__.value,
	document.newReminderForm__MODULE_ID__.
	newDay__MODULE_ID__.value
	)"> <input size="12" id="newDescription__MODULE_ID__" type="text"
		/> <input size="4" id="newYear__MODULE_ID__" 
		value="" type="text"> <input size="2" id="newMonth__MODULE_ID__" 
		value="" type="text"> <input size="2" id="newDay__MODULE_ID__" 
		value="" type="text"> <input type='button' value="__MSG_Add__"
		onclick = "javascript:addReminder__MODULE_ID__(
		document.newReminderForm__MODULE_ID__.
		newDescription__MODULE_ID__.value,
		document.newReminderForm__MODULE_ID__.
		newYear__MODULE_ID__.value,
		document.newReminderForm__MODULE_ID__.
		newMonth__MODULE_ID__.value,
		document.newReminderForm__MODULE_ID__.
		newDay__MODULE_ID__.value
		)" />
</form>
<div id="remindersDiv__MODULE_ID__"></div>
]]>
</Content>
</Module>

